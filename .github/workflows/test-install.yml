name: Test Install Script

on:
  push:
    branches:
      - main
    paths:
      - install.sh
      - stable.txt
      - cmd/tntc/**
      - pkg/**
  pull_request:
    paths:
      - install.sh
      - stable.txt
      - cmd/tntc/**
      - pkg/**

jobs:
  syntax:
    name: Syntax check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check shell syntax
        run: sh -n install.sh

  install:
    name: End-to-end install test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build tntc binary
        run: |
          go build \
            -trimpath \
            -ldflags "-s -w \
              -X github.com/randybias/tentacular/pkg/version.Version=test \
              -X github.com/randybias/tentacular/pkg/version.Commit=$(git rev-parse --short HEAD) \
              -X github.com/randybias/tentacular/pkg/version.Date=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            -o tntc_linux_amd64 \
            ./cmd/tntc

      - name: Set up mock release server
        run: |
          VERSION=$(cat stable.txt)
          mkdir -p mock-releases/${VERSION}
          cp tntc_linux_amd64 mock-releases/${VERSION}/tntc_linux_amd64
          cp stable.txt mock-releases/stable.txt
          cd mock-releases && python3 -m http.server 8888 &
          # Wait for server to be ready
          for i in $(seq 1 10); do
            curl -sf http://localhost:8888/stable.txt && break
            sleep 1
          done

      - name: Patch and run install script
        run: |
          sed \
            -e 's|https://github.com/${GITHUB_REPO}/releases/download|http://localhost:8888|g' \
            -e 's|https://raw.githubusercontent.com/${GITHUB_REPO}/main/stable.txt|http://localhost:8888/stable.txt|g' \
            install.sh > install-test.sh
          TNTC_INSTALL_DIR=$HOME/.local/bin sh install-test.sh

      - name: Verify binary
        run: $HOME/.local/bin/tntc version
